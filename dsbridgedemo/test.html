<!DOCTYPE html>
<html>
    <head lang="zh-cmn-Hans">
        <meta charset="UTF-8">
            <title>DWebviewJavaScriptBridge Test</title>
            <meta name="renderer" content="webkit">
                <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
                    <meta name="viewport" content="width=device-width,initial-scale=0.5,user-scalable=no"/>
                    
                    </head>
    <style>
        .btn {
            text-align: center;
            background: dodgerblue;
            color: white;
            padding: 20px;
            margin: 30px;
            font-size: 24px;
            border-radius: 4px;
            box-shadow: 4px 2px 10px #999;
        }
    
    .btn:active {
        opacity: .7;
        box-shadow: 4px 2px 10px #555;
    }
    
        </style>
    <body>
        <div class="btn" onclick="callSync()">Sync Call</div>
        <div class="btn" onclick="callAsync()">Async Call</div>
        <div class="btn" onclick="callNoArgSync()">No Arg Sync Call</div>
        <div class="btn" onclick="callNoArgAsync()">No Arg Async Call</div>
        <div class="btn" onclick="callAsyn_()">Async Call for 100k times</div>
        <div class="btn" onclick="callNever()">Call Unexist Method</div>
        
        <div class="btn" onclick="callProgress()">Progress Call <span id='progress'></span></div>
        <div class="btn" onclick="alert(confirm('Press a button'))">confirm test</div>
        <div class="btn" onclick="alert(prompt('Please input user name.','Hello, world'))">prompt test</div>
        
<script>
/* BRIDGE BEGIN */
function getJsBridge(bridgeName) {
  var internalBridgeName = bridgeName || '_dsbridge';
  var internalBridge = window[internalBridgeName];
  if (!internalBridge) {
    throw new Error('No injected global bridge object.');
  }

  var counter = 0;
  var jsBridge = {
    callbackMap: {},
    handlerMap: {},
    callHandler: function (name, args, callback) {
      var ret = '';
      if (typeof args == 'function') {
        callback = args;
        args = {};
      }
      if (typeof callback == 'function') {
        var callbackId = counter++;
        this.callbackMap[callbackId] = callback;
        args['_callbackId'] = callbackId;
      }
      args = JSON.stringify(args || {});

      // WKWebview
      if (internalBridge.wk) {
        ret = prompt(internalBridgeName + '=' + name, args);
      } else {
        ret = internalBridge.callHandler(name, args);
      }
      return ret;
    },
    registerHandler: function (name, handler) {
      this.handlerMap[name] = handler;
    },
    init: function () {
      if (internalBridge.wk) {
        prompt(internalBridgeName + 'init=');
      } else {
        internalBridge.init();
      }
    },
  };

  // extend internal bridge
  internalBridge.invokeHandler = function (name, args, callbackId) {
    var handler = jsBridge.handlerMap[name];
    var sendResponse = function (result) {
      if (typeof callbackId !== 'number') return;
      if (internalBridge.wk) {
        prompt(internalBridgeName + 'cid=' + callbackId, result);
      } else {
        internalBridge.returnValue(callbackId, result);
      }
    };

    if (handler.length === 2) {
      // async handler
      handler(args, function (response) {
        sendResponse(JSON.stringify(response));
      });
    } else {
      var response = {};
      try {
        response.result = handler(args);
      } catch (ex) {
        response.error = ex.toString();
      }
      sendResponse(JSON.stringify(response));
    }
  };
  internalBridge.invokeCallback = function (callbackId, result, complete) {
    var callback = jsBridge.callbackMap[callbackId];
    if (complete) {
      delete jsBridge.callbackMap[callbackId];
    }
    callback(result);
  };

  return jsBridge;
}
/* BRIDGE END */

// bridge demo

var bridge = getJsBridge();
bridge.init();

function callSync() {
  alert(bridge.callHandler('testSync', { msg: 'testSync' }));
}

function callAsync() {
  bridge.callHandler('testAsync', { msg: 'testAsync' }, function (ret) {
    if (ret.error) {
      console.error(ret.error);
      return;
    }
    alert(ret.result);
  });
}

function callNoArgSync() {
  alert(bridge.callHandler('testNoArgSync'));
}

function callNoArgAsync() {
  bridge.callHandler('testNoArgAsync', function (ret) {
    if (ret.error) {
      console.error(ret.error);
      return;
    }
    alert(ret.result);
  });
}

function callNever() {
  bridge.callHandler('testNever', { msg: 'testNever' });
}

function callProgress(){
  bridge.callHandler('callProgress', function (ret) {
    if (ret.error) {
      console.error(ret.error);
      return;
    }
    document.getElementById('progress').innerText = ret.result;
  });
}

// sync handler
bridge.registerHandler('addValue', function (data) {
  return data[0] + data[1];
});

// async handler
bridge.registerHandler('addValueAsync', function (data, callback) {
  callback({ result: data[0] + data[1] });
});
</script>
    </body>
</html>
